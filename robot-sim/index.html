<!DOCTYPE html>
<html>
<head>
    <style>
        .cell {
            justify-content: center;
            align-items: center;
            display: flex;
            background: white;
        }
    </style>
    <script>
        window.onload = function () {
            var currentSpeed = 1000;

            var resetBtn = document.getElementById("btn-reset");
            var addRobBtn = document.getElementById("btn-addRob");

            var tickSpeedBtn = document.getElementById("btn-tickSpeed");
            var robMaxBtn = document.getElementById("btn-robMax");
            var faultBtn = document.getElementById("btn-fault");
            var multBtn = document.getElementById("btn-mult");

            var requestAwaitResponse = false;

            grid("build", undefined);

            loop();
            function loop() {
                fetch("http://localhost:8000/complete")
                    .then(response => response.json())
                    .then(data => {
                        if (data.tickSpeed <= 250) {
                            currentSpeed = 250;
                        } else if (data.tickSpeed >= 1000) {
                            currentSpeed = 1000;
                        } else {
                            currentSpeed = data.tickSpeed;
                        }

                        document.getElementById("txt-tick").textContent = data.ticks + " (1 tick / " + data.tickSpeed + "ms)";
                        document.getElementById("txt-robots").textContent = data.robots.length + " / " + data.robotCap;
                        document.getElementById("txt-norm-fault").textContent = data.faultChance + "%";
                        document.getElementById("txt-pers-fault").textContent = data.faultChance * data.personalityMultiplier + "% (" + data.faultChance + " * " + data.personalityMultiplier + ")";

                        resetBtn.disabled = data.resetFlag || requestAwaitResponse;
                        addRobBtn.disabled = requestAwaitResponse;

                        tickSpeedBtn.disabled = requestAwaitResponse;
                        robMaxBtn.disabled = requestAwaitResponse;
                        faultBtn.disabled = requestAwaitResponse;
                        multBtn.disabled = requestAwaitResponse;

                        grid("clear", data.pickers);
                        drawPaths(data.robots);
                        drawRobots(data.robots);
                        getAndDisplayRaw();
                    });
                window.setTimeout(loop, currentSpeed);
            };

            function grid(task, pickers) {
                var grid = document.getElementById("grid");
                for (let i = 49; i >= 0; i--) {
                    for (let j = 0; j < 100; j++) {
                        if (task === "build") {
                            const square = document.createElement("div");
                            square.className = "cell";
                            square.id = j + "-" + i
                            grid.appendChild(square);
                        } else {
                            document.getElementById(j + "-" + i).style.backgroundColor = "white";
                            if (i === 0) {
                                for (let picker of pickers) {
                                    if (j === picker.x) {
                                        document.getElementById(j + "-" + i).style.backgroundColor = "#9999ff"; // picker color
                                    }
                                }
                            }
                        }
                    }
                }
            }

            function drawPaths(robots) {
                for (let robot of robots) {
                    for (let move of robot.expectedPath) {
                        if (!(move.x === robot.pickerLocation.x && move.y === robot.pickerLocation.y)) {
                            document.getElementById(move.x + "-" + move.y).style.backgroundColor = "#e6e6ff"; // path color
                        }
                    }
                }
            }

            function drawRobots(robots) {
                for (let robot of robots) {
                    if (robot.statusFlag === 4) {
                        document.getElementById(robot.position.x + "-" + robot.position.y).style.backgroundColor = "#66ff66"; // success color
                    } else if (robot.statusFlag === 3) {
                        document.getElementById(robot.position.x + "-" + robot.position.y).style.backgroundColor = "#ff6666"; // broken color
                    } else if (robot.statusFlag === 2) {
                        document.getElementById(robot.position.x + "-" + robot.position.y).style.backgroundColor = "#ffff66"; // warning color
                    } if (robot.statusFlag === 0) {
                        document.getElementById(robot.position.x + "-" + robot.position.y).style.backgroundColor = "#ff9538"; // reset color
                    } else if (robot.statusFlag === 1) {
                        document.getElementById(robot.position.x + "-" + robot.position.y).style.backgroundColor = "#999999"; // normal color
                    }
                }
            }

            function getAndDisplayRaw() {
                var elmnt = document.getElementById("listing");
                while (elmnt.firstChild) {
                    elmnt.removeChild(elmnt.firstChild);
                }

                fetch("http://localhost:8000/raw")
                    .then(response => response.json())
                    .then(data => {
                        var dat = data;
                        for (let rbt of dat) {
                            var nelmnt = document.createElement("div");
                            nelmnt.textContent = JSON.stringify(rbt);
                            document.getElementById("listing").appendChild(nelmnt);
                        }
                    });
            }

            resetBtn.onclick = () => editValue(resetBtn, "reset", "");
            addRobBtn.onclick = () => editValue("", "robot", "");

            tickSpeedBtn.onclick = () => editValue(tickSpeedBtn, "speed", document.getElementById("input-tickSpeed").value);
            robMaxBtn.onclick = () => editValue(robMaxBtn, "max", document.getElementById("input-robMax").value);
            faultBtn.onclick = () => editValue(faultBtn, "fault", document.getElementById("input-fault").value);
            multBtn.onclick = () => editValue(multBtn, "mult", document.getElementById("input-mult").value);
            function editValue(object, field, value) {
                if (object !== "") {
                    object.disabled = true;
                }
                requestAwaitResponse = true;
                fetch("http://localhost:8000/edit", {
                    method: "PUT",
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ field, value }),
                }).then(() => requestAwaitResponse = false);
            }
        };
    </script>
</head>
<body>
    <div style="display: flex;">
        <!-- grid (right) -->
        <div class="container" style="background: black; border: 1px solid black; margin: 0 15px 15px 0;">
            <div class="grid" id="grid" style="display: grid; grid-template-columns: repeat(100, 11px); grid-template-rows: repeat(50, 11px); grid-gap: 1px;"></div>
        </div>

        <!-- data (left) -->
        <div>
            <!-- tick count text -->
            <div>
                <p style="font-weight: bold; display: inline-block; margin-right: 5px; margin-bottom: 0;">Tick:</p>
                <p id="txt-tick" style="display: inline-block; margin: 0;"></p>
            </div>

            <!-- robot count text and button -->
            <div>
                <p style="font-weight: bold; display: inline-block; margin-right: 5px; margin-bottom: 0;">Robots:</p>
                <p id="txt-robots" style="display: inline-block; margin: 0;"></p>
                <button id="btn-addRob">Add</button>
            </div>

            <!-- fault chance text -->
            <div>
                <p style="font-weight: bold; display: inline-block; margin-right: 5px; margin-bottom: 0;">Normal fault chance:</p>
                <p id="txt-norm-fault" style="display: inline-block; margin: 0;"></p>
            </div>

            <!-- personality multiplier text -->
            <div>
                <p style="font-weight: bold; display: inline-block; margin-right: 5px; margin-bottom: 0;">Personality fault chance:</p>
                <p id="txt-pers-fault" style="display: inline-block; margin: 0;"></p>
            </div>

            <!-- reset button -->
            <div>
                <button id="btn-reset" style="display: inline-block; margin-top: 1em; margin-bottom: 0;">reset</button>
            </div>

            <!-- spacer -->
            <div style="margin: 50px;"></div>

            <!-- tick speed input -->
            <div style="margin-bottom: 10px;">
                <div>Tick speed</div>
                <input id="input-tickSpeed" type="number" placeholder="Milliseconds" /><button id="btn-tickSpeed">Change</button>
            </div>

            <!-- robot maximum input -->
            <div style="margin-bottom: 10px;">
                <div>Robots max</div>
                <input id="input-robMax" type="number" /><button id="btn-robMax">Change</button>
            </div>

            <!-- fault chance input -->
            <div style="margin-bottom: 10px;">
                <div>Fault chance (%)</div>
                <input id="input-fault" type="number" placeholder="Percent" /><button id="btn-fault">Change</button>
            </div>

            <!-- personality multiplier input -->
            <div style="margin-bottom: 10px;">
                <div>Personality multiplier</div>
                <input id="input-mult" type="number" /><button id="btn-mult">Change</button>
            </div>
        </div>
    </div>

    <!-- data print -->
    <a href="http://localhost:8000/raw" style="margin-bottom: 10px;">http://localhost:8000/raw</a>
    <div id="listing"></div>

</body>
</html>